<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>AquaNet ‚Äì –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
            :root {
                --blue-main: #3bbaff;
                --blue-soft: #d9f2ff;
                --blue-dark: #1b6fa8;
                --gray-bg: #f7f9fb;
                --gray-text: #6b7280;
                --card-border: rgba(0,0,0,0.08);
            }

            body {
                background: var(--gray-bg);
                color: #1f2937;
                font-family: "Inter", system-ui, sans-serif;
            }

            /* Top bar */
            .topbar {
                background: white;
                border-bottom: 1px solid var(--card-border);
                padding: 0.8rem 1rem;
            }

            .topbar-title {
                font-weight: 600;
                font-size: 1.15rem;
            }

            .topbar-subtitle {
                color: var(--gray-text);
                font-size: 0.85rem;
            }

            .badge-deficit {
                background: var(--blue-soft);
                border: 1px solid var(--blue-main);
                color: var(--blue-dark);
                border-radius: 999px;
                padding: 0.35rem 0.9rem;
                font-size: 0.8rem;
            }

            .btn-top {
                border-radius: 999px;
                font-size: 0.8rem;
                padding-inline: 1rem;
            }

            .btn-top-active {
                background: var(--blue-main);
                color: white;
            }

            .btn-top-outline {
                border: 1px solid var(--blue-main);
                color: var(--blue-dark);
                background: white;
            }

            .btn-top-outline:hover {
                background: var(--blue-soft);
                color: var(--blue-dark);
            }

            /* Page spacing */
            .page-wrap {
                padding: 1.5rem 1.25rem;
            }

            .page-title {
                font-size: 1.35rem;
                font-weight: 600;
                margin-bottom: 0.3rem;
            }

            .page-subtitle {
                color: var(--gray-text);
                font-size: 0.9rem;
                margin-bottom: 1.3rem;
            }

            /* Summary cards */
            .summary-card {
                background: white;
                border-radius: 1rem;
                border: 1px solid var(--card-border);
                padding: 1.2rem;
                text-align: center;
            }

            .summary-value {
                font-size: 1.4rem;
                font-weight: 700;
                color: var(--blue-dark);
            }

            .summary-label {
                font-size: 0.85rem;
                color: var(--gray-text);
            }

            /* Analytics blocks */
            .section-card {
                background: white;
                border-radius: 1rem;
                border: 1px solid var(--card-border);
            }

            .section-header {
                padding: 0.9rem 1rem;
                border-bottom: 1px solid var(--card-border);
                font-size: 1rem;
                font-weight: 600;
            }

            .chart-wrapper {
                padding: 1rem 1.3rem;
            }

            .chart-wrapper canvas {
                max-height: 160px;
            }

            /* Tables */
            table.table {
                font-size: 0.85rem;
            }

            table.table th {
                color: var(--gray-text);
                font-weight: 600;
            }

            table.table td {
                color: #1f2937;
            }

            .cell-muted {
                color: var(--gray-text);
            }
        </style>
</head>

<body>

<!-- Top -->
<nav class="topbar">
    <div class="container-fluid px-3 px-md-4 py-2 d-flex justify-content-between align-items-center">
        <div>
            <div class="topbar-title">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ AquaNet</div>
            <div class="topbar-subtitle">–°–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ—Ç–∏ –ø–æ–ª–∏–≤–∞</div>
        </div>

        <div class="d-flex align-items-center gap-3">
            <span class="badge-deficit">
                –î–µ—Ñ–∏—Ü–∏—Ç –≤–æ–¥—ã: <strong><%= deficit %>%</strong>
            </span>

            <div class="btn-group">
                <a href="/admin" class="btn btn-top btn-top-outline btn-sm">–§–µ—Ä–º–µ—Ä—ã</a>
                <a href="/admin/analytics" class="btn btn-top btn-top-active btn-sm">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
                <a href="/" class="btn btn-top btn-top-outline btn-sm">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</a>
            </div>
        </div>
    </div>
</nav>

<div class="page-wrap container-fluid">

    <h1 class="page-title">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ç–∏</h1>
    <p class="page-subtitle">
        –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º, –∫—É–ª—å—Ç—É—Ä–∞–º –∏ –Ω–∞–≥—Ä—É–∑–∫–µ –Ω–∞ –∏—Ä—Ä–∏–≥–∞—Ü–∏–æ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É.
    </p>

    <!-- Summary cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="summary-card">
                <div class="summary-value"><%= totalFarmers %></div>
                <div class="summary-label">–í—Å–µ–≥–æ —Ñ–µ—Ä–º–µ—Ä–æ–≤</div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="summary-card">
                <div class="summary-value"><%= totalArea.toFixed(1) %> –≥–∞</div>
                <div class="summary-label">–û–±—â–∞—è –æ—Ä–æ—à–∞–µ–º–∞—è –ø–ª–æ—â–∞–¥—å</div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="summary-card">
                <div class="summary-value"><%= deficit %>%</div>
                <div class="summary-label">–¢–µ–∫—É—â–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç</div>
            </div>
        </div>
    </div>

    <!-- Graphs -->
    <div class="row g-4 mb-4">

        <!-- –û–±–ª–∞—Å—Ç–∏ -->
        <div class="col-lg-6">
            <div class="section-card">
                <div class="section-header">üìç –§–µ—Ä–º–µ—Ä—ã –ø–æ –æ–±–ª–∞—Å—Ç—è–º</div>
                <div class="chart-wrapper">
                    <canvas id="oblastChart"></canvas>
                </div>
            </div>
        </div>

        <!-- –ö—É–ª—å—Ç—É—Ä—ã -->
        <div class="col-lg-6">
            <div class="section-card">
                <div class="section-header">üå± –§–µ—Ä–º–µ—Ä—ã –ø–æ –∫—É–ª—å—Ç—É—Ä–∞–º</div>
                <div class="chart-wrapper">
                    <canvas id="cropChart"></canvas>
                </div>
            </div>
        </div>

    </div>

    <!-- Tables -->
   <div class="row g-4">

           <div class="col-lg-6">
               <div class="section-card">
                   <div class="section-header">üìç –ü–æ –æ–±–ª–∞—Å—Ç—è–º</div>

                   <table class="table table-hover mb-0">
                       <thead>
                           <tr>
                               <th>–û–±–ª–∞—Å—Ç—å</th>
                               <th>–§–µ—Ä–º–µ—Ä–æ–≤</th>
                               <th>–ü–ª–æ—â–∞–¥—å</th>
                           </tr>
                       </thead>
                       <tbody>
                       <% if (byOblast.length === 0) { %>
                           <tr><td colspan="3" class="cell-muted text-center py-3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                       <% } else { %>
                           <% byOblast.forEach(r => { %>
                               <tr>
                                   <td><%= r.oblast || '‚Äî' %></td>
                                   <td><%= r.count %></td>
                                   <td><%= (r.area || 0).toFixed(1) %> –≥–∞</td>
                               </tr>
                           <% }) %>
                       <% } %>
                       </tbody>
                   </table>

               </div>
           </div>

           <div class="col-lg-6">
               <div class="section-card">
                   <div class="section-header">üå± –ü–æ –∫—É–ª—å—Ç—É—Ä–∞–º</div>

                   <table class="table table-hover mb-0">
                       <thead>
                       <tr>
                           <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                           <th>–§–µ—Ä–º–µ—Ä–æ–≤</th>
                           <th>–ü–ª–æ—â–∞–¥—å</th>
                       </tr>
                       </thead>
                       <tbody>
                       <% if (byCrop.length === 0) { %>
                           <tr><td colspan="3" class="cell-muted text-center py-3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                       <% } else { %>
                           <% byCrop.forEach(r => { %>
                               <tr>
                                   <td><%= r.crop || '‚Äî' %></td>
                                   <td><%= r.count %></td>
                                   <td><%= (r.area || 0).toFixed(1) %> –≥–∞</td>
                               </tr>
                           <% }) %>
                       <% } %>
                       </tbody>
                   </table>

               </div>
           </div>

       </div>

</div>

<script>
    const oblast = <%- JSON.stringify(byOblast.filter(o => o.oblast)) %>;
    const crop = <%- JSON.stringify(byCrop.filter(c => c.crop)) %>;

    // Chart 1 ‚Äî –æ–±–ª–∞—Å—Ç–∏
    new Chart(document.getElementById("oblastChart"), {
        type: "bar",
        data: {
            labels: oblast.map(o => o.oblast),
            datasets: [{
                data: oblast.map(o => o.count),
                backgroundColor: "rgba(59,186,255,0.6)"
            }]
        },
        options: {
            plugins: { legend: { display: false }},
            scales: {
                x: { ticks: { color: "#6b7280" }},
                y: { ticks: { color: "#6b7280" }}
            }
        }
    });

    // Chart 2 ‚Äî –∫—É–ª—å—Ç—É—Ä—ã
    new Chart(document.getElementById("cropChart"), {
        type: "pie",
        data: {
            labels: crop.map(c => c.crop),
            datasets: [{
                data: crop.map(c => c.count),
                backgroundColor: ["#3bbaff", "#1b6fa8", "#4ade80", "#fbbf24", "#f87171"]
            }]
        },
        options: {
            plugins: { legend: { labels: { color: "#1f2937" }}}
        }
    });
</script>

</body>
</html>